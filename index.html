<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imagine Mind: AI Image Generator & Editor</title>
    <meta name="description" content="Generate unique images from text prompts and edit your photos with AI, powered by Gemini.">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-32VR3DNEC3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-32VR3DNEC3');
    </script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase JS SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <style>
        /* Custom Styles (shortened here for brevity) */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg,#0f172a,#1e293b 40%,#3b82f6 100%);
            min-height: 100vh;
        }
        .animate-spin-custom {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg);}
            to { transform: rotate(360deg);}
        }
        /* Add the rest of your custom styles or paste your original CSS here */
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-950 to-gray-950">

    <!-- Firebase Auth Modals -->
    <div id="authModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
      <div class="bg-white rounded-2xl shadow-xl w-[95vw] max-w-md p-8 text-gray-800">
        <h2 class="text-2xl font-bold mb-4" id="authModalTitle">Sign In</h2>
        <form id="authForm" class="space-y-4">
          <input id="authEmail" type="email" placeholder="Email" required class="w-full py-2 px-3 border rounded" />
          <input id="authPassword" type="password" placeholder="Password" required class="w-full py-2 px-3 border rounded" />
          <div id="authError" class="text-red-600 font-semibold text-sm"></div>
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Continue</button>
        </form>
        <div class="flex justify-between mt-4 text-sm">
          <button id="switchToSignUp" class="text-blue-600 hover:underline">Don't have an account? Sign up</button>
          <button id="switchToSignIn" class="text-blue-600 hover:underline hidden">Already have an account? Sign in</button>
        </div>
      </div>
    </div>
    <!-- Email Verification Banner -->
    <div id="verifyBanner" class="hidden fixed top-0 left-0 w-full bg-yellow-400 text-gray-900 text-center py-3 z-40">
      Please verify your email address.
      <button id="sendVerifyEmail" class="ml-3 bg-blue-700 hover:bg-blue-800 text-white px-2 py-1 rounded">Resend Verification Email</button>
      <button id="signOutBtn" class="ml-3 bg-gray-700 hover:bg-gray-800 text-white px-2 py-1 rounded">Sign Out</button>
    </div>
    <!-- Auth Button -->
    <button id="authOpenBtn" class="fixed top-5 right-8 z-40 bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded font-bold shadow-lg">Sign In</button>
    <button id="signOutBtnMain" class="fixed top-5 right-8 z-40 bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded font-bold shadow-lg hidden">Sign Out</button>
    
    <!-- Fixed Header with Hamburger Icon and Title -->
    <div id="fixedHeader" class="w-full fixed top-0 left-0 bg-slate-900 bg-opacity-95 shadow-lg flex items-center px-8 py-3 z-30">
        <div class="flex items-center space-x-4">
            <button id="menuToggleBtn" class="p-2 rounded-full bg-blue-600 text-white shadow-lg hover:bg-blue-700 transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
            <span class="text-3xl md:text-4xl font-extrabold text-white">Imagine Mind</span>
        </div>
    </div>
    <!-- Navigation Menu (Dropdown) -->
    <div id="navMenu" class="hidden">
        <button id="showHomeBtn" class="active">Home</button>
        <button id="showGeneratorBtn">Image Generator</button>
        <button id="showEditorBtn">Image Editor</button>
    </div>
    <!-- Main Content Sections -->
    <main class="w-full max-w-6xl flex flex-col items-center p-4 pt-32">
        <!-- Home Section -->
        <section id="homeSection" class="w-full text-center mx-auto my-8 flex flex-col justify-center min-h-[calc(100vh-100px)]">
            <h1 class="text-5xl md:text-6xl font-extrabold mb-4 leading-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-sky-300 to-indigo-400">
                    Welcome to Imagine Mind!
                </span>
            </h1>
            <p class="text-slate-200 text-xl md:text-2xl max-w-2xl mx-auto mb-10">
                Unleash your creativity with AI-powered image generation and editing.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                <!-- Image Generator Card -->
                <div class="bg-slate-900 bg-opacity-40 p-8 rounded-3xl shadow-xl border border-blue-700 border-opacity-30 flex flex-col items-center">
                    <h2 class="text-3xl font-bold text-slate-100 mb-4">Image Generator</h2>
                    <p class="text-slate-300 mb-6 text-lg text-left flex-grow">
                        Transform textual prompts into rich visual masterpieces. Input detailed descriptions and let AI bring your ideas to life.
                    </p>
                    <button id="homeToGeneratorBtn" class="px-8 py-4 rounded-xl bg-blue-600 text-white font-semibold text-lg hover:bg-blue-700 transition-colors duration-200 shadow-lg hover:shadow-xl">
                        Try Image Generator
                    </button>
                </div>
                <!-- Image Editor Card -->
                <div class="bg-slate-900 bg-opacity-40 p-8 rounded-3xl shadow-xl border border-blue-700 border-opacity-30 flex flex-col items-center">
                    <h2 class="text-3xl font-bold text-slate-100 mb-4">Image Editor</h2>
                    <p class="text-slate-300 mb-6 text-lg text-left flex-grow">
                        Upload your images and manipulate them with AI. Describe complex edits like style transfer or background changes, and get stunning results.
                    </p>
                    <button id="homeToEditorBtn" class="px-8 py-4 rounded-xl bg-blue-600 text-white font-semibold text-lg hover:bg-blue-700 transition-colors duration-200 shadow-lg hover:shadow-xl">
                        Try Image Editor
                    </button>
                </div>
            </div>
        </section>
        <!-- Image Generator Section -->
        <section id="generatorSection" class="w-full max-w-3xl bg-slate-900 bg-opacity-30 p-8 rounded-3xl shadow-2xl border-2 border-blue-600 border-opacity-40 my-10 hidden">
            <h2 class="text-4xl md:text-5xl font-extrabold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-sky-300 to-indigo-400">
                Image Generator
            </h2>
            <p class="text-slate-300 mb-8 text-lg md:text-xl">
                Unleash your imagination and generate stunning visuals with the power of AI.
            </p>
            <div class="mb-8">
                <label for="generatorPromptInput" class="block text-left text-slate-300 text-base font-semibold mb-2">
                    Image Prompt:
                </label>
                <textarea id="generatorPromptInput" class="w-full p-5 border border-blue-500 border-opacity-50 rounded-xl outline-none text-slate-200 placeholder-slate-400 resize-none bg-slate-800" rows="6"
                    placeholder="e.g., 'A majestic dragon soaring over a bioluminescent forest at twilight, intricate details, fantasy art, volumetric lighting, 8k.'"></textarea>
            </div>
            <button id="generateImageButton"
                class="w-full py-4 px-8 rounded-xl text-white font-extrabold text-xl shadow-lg bg-blue-600 hover:bg-blue-700 transition-colors duration-200">
                <div id="generateButtonContent" class="flex items-center justify-center">
                    <span>Generate Image</span>
                </div>
            </button>
            <div id="generatorErrorContainer" class="mt-8 p-5 bg-red-800 bg-opacity-70 border border-red-600 text-red-100 rounded-lg text-lg shadow-xl hidden">
            </div>
            <div id="generatedImageResultContainer" class="mt-10 hidden">
                <h2 class="text-3xl font-bold text-slate-100 mb-6">Your Creation:</h2>
                <div class="relative w-full h-auto rounded-xl shadow-aura-lg border-4 border-blue-500 flex items-center justify-center bg-slate-900 bg-opacity-50 p-3 overflow-hidden">
                    <img id="generatedImage" src="" alt="Generated AI image based on user prompt"
                        class="max-w-full h-auto object-contain rounded-lg shadow-md transition-transform duration-300 hover:scale-105">
                </div>
                <div class="mt-6 flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <label for="generatorDownloadFormat" class="text-slate-300 font-semibold">Download as:</label>
                    <select id="generatorDownloadFormat" class="p-2 rounded-lg bg-slate-700 text-white border border-slate-600">
                        <option value="image/png">PNG</option>
                        <option value="image/jpeg">JPEG</option>
                        <option value="image/webp">WebP</option>
                    </select>
                    <button id="downloadGeneratedButton"
                        class="py-3.5 px-8 rounded-xl text-gray-900 font-bold text-lg bg-gray-200 hover:bg-gray-300">
                        Download Image
                    </button>
                </div>
            </div>
        </section>
        <!-- Image Editor Section -->
        <section id="editorSection" class="w-full max-w-3xl bg-slate-900 bg-opacity-30 p-8 rounded-3xl shadow-2xl border-2 border-blue-600 border-opacity-40 my-10 hidden">
            <h2 class="text-4xl md:text-5xl font-extrabold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-sky-300 to-indigo-400">
                Image Editor
            </h2>
            <p class="text-slate-300 mb-8 text-lg md:text-xl">
                Upload an image and use AI to transform it!
            </p>
            <div class="mb-8">
                <label for="editorImageUpload" class="block text-left text-slate-300 text-base font-semibold mb-2">
                    Upload Image:
                </label>
                <input type="file" id="editorImageUpload" accept="image/*" class="hidden">
                <div class="flex items-center space-x-3">
                    <div id="editorCustomFileUploadButton" class="bg-blue-600 px-4 py-2 rounded-lg text-white cursor-pointer hover:bg-blue-700">
                        <span>Choose File</span>
                    </div>
                    <span id="editorFileNameDisplay" class="text-slate-400">No file chosen</span>
                </div>
                <div id="editorPreviewContainer" class="mt-6 flex justify-center items-center bg-slate-800 rounded-xl p-4 border-2 border-dashed border-blue-500 min-h-[200px] overflow-hidden">
                    <img id="editorImagePreview" src="#" alt="Preview of uploaded image" class="max-w-full max-h-56 object-contain rounded-lg shadow-md hidden">
                    <p id="editorImagePlaceholder" class="text-gray-400 text-lg">No image uploaded</p>
                </div>
            </div>
            <div class="mb-8">
                <label for="editorPromptInputText" class="block text-left text-slate-300 text-base font-semibold mb-2">
                    Describe your desired edit:
                </label>
                <textarea id="editorPromptInputText" class="w-full p-4 border border-slate-600 rounded-xl bg-slate-800 text-slate-200 placeholder-slate-400" rows="5"
                    placeholder="e.g., 'Change the car color to red and add a futuristic cityscape in the background.'"></textarea>
            </div>
            <button id="editorEditButton"
                class="w-full py-4 px-6 rounded-xl text-white font-bold text-xl bg-blue-600 hover:bg-blue-700">
                <div id="editorButtonContent" class="flex items-center justify-center">
                    <span>Edit Image</span>
                </div>
            </button>
            <div id="editorErrorContainer" class="mt-8 p-4 bg-red-800 bg-opacity-70 border border-red-600 text-red-100 rounded-lg text-base shadow-md hidden"></div>
            <div id="editorEditedImageResultContainer" class="mt-10 hidden">
                <h2 class="text-2xl font-bold text-slate-100 mb-5">Edited Image:</h2>
                <div class="relative w-full h-auto rounded-xl shadow-xl border-2 border-blue-400 flex items-center justify-center bg-slate-800 p-4 min-h-[200px] overflow-hidden">
                    <img id="editorEditedImage" src="" alt="AI-edited image based on user prompt"
                        class="max-w-full h-auto object-contain rounded-lg shadow-md">
                </div>
                <div class="mt-6 flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <label for="editorDownloadFormat" class="text-slate-300 font-semibold">Download as:</label>
                    <select id="editorDownloadFormat" class="p-2 rounded-lg bg-slate-700 text-white border border-slate-600">
                        <option value="image/png">PNG</option>
                        <option value="image/jpeg">JPEG</option>
                        <option value="image/webp">WebP</option>
                    </select>
                    <button id="downloadEditorEditedButton"
                        class="py-3 px-6 rounded-xl text-gray-800 font-semibold text-lg bg-yellow-300 hover:bg-yellow-400">
                        Download Edited Image
                    </button>
                </div>
            </div>
        </section>
    </main>
    <!-- Footer -->
    <footer class="mt-auto w-full bg-slate-900 bg-opacity-95 text-slate-300 text-center py-4 border-t border-blue-600 border-opacity-40 rounded-t-xl shadow-lg">
        <p class="text-lg"></p>
    </footer>
    <!-- Main Application Script -->
    <script type="module">
        // --- Firebase Auth Integration ---
        // Replace with your actual Firebase config
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_AUTH_DOMAIN",
          projectId: "YOUR_PROJECT_ID",
          appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        // Auth DOM
        const authModal = document.getElementById('authModal');
        const authOpenBtn = document.getElementById('authOpenBtn');
        const authForm = document.getElementById('authForm');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authError = document.getElementById('authError');
        const switchToSignUp = document.getElementById('switchToSignUp');
        const switchToSignIn = document.getElementById('switchToSignIn');
        const authModalTitle = document.getElementById('authModalTitle');
        const signOutBtn = document.getElementById('signOutBtn');
        const signOutBtnMain = document.getElementById('signOutBtnMain');
        const verifyBanner = document.getElementById('verifyBanner');
        const sendVerifyEmail = document.getElementById('sendVerifyEmail');
        let isSignUpMode = false;
        authOpenBtn.onclick = () => {
          authModal.classList.remove('hidden');
          isSignUpMode = false;
          authModalTitle.textContent = "Sign In";
          switchToSignUp.classList.remove('hidden');
          switchToSignIn.classList.add('hidden');
          authError.textContent = "";
          authForm.reset();
        };
        switchToSignUp.onclick = () => {
          isSignUpMode = true;
          authModalTitle.textContent = "Sign Up";
          switchToSignUp.classList.add('hidden');
          switchToSignIn.classList.remove('hidden');
          authError.textContent = "";
          authForm.reset();
        };
        switchToSignIn.onclick = () => {
          isSignUpMode = false;
          authModalTitle.textContent = "Sign In";
          switchToSignUp.classList.remove('hidden');
          switchToSignIn.classList.add('hidden');
          authError.textContent = "";
          authForm.reset();
        };
        authModal.addEventListener('click', (e) => {
          if (e.target === authModal) authModal.classList.add('hidden');
        });
        authForm.onsubmit = async (e) => {
          e.preventDefault();
          authError.textContent = "";
          const email = authEmail.value;
          const password = authPassword.value;
          try {
            if (isSignUpMode) {
              const { user } = await auth.createUserWithEmailAndPassword(email, password);
              await user.sendEmailVerification();
              alert("Verification email sent. Please check your inbox.");
              authModal.classList.add('hidden');
            } else {
              await auth.signInWithEmailAndPassword(email, password);
              authModal.classList.add('hidden');
            }
          } catch (err) {
            authError.textContent = err.message;
          }
        };
        auth.onAuthStateChanged(async user => {
          if (user) {
            if (!user.emailVerified) {
              verifyBanner.classList.remove('hidden');
              authOpenBtn.classList.add('hidden');
              signOutBtnMain.classList.remove('hidden');
            } else {
              verifyBanner.classList.add('hidden');
              authOpenBtn.classList.add('hidden');
              signOutBtnMain.classList.remove('hidden');
            }
          } else {
            verifyBanner.classList.add('hidden');
            authOpenBtn.classList.remove('hidden');
            signOutBtnMain.classList.add('hidden');
          }
        });
        sendVerifyEmail.onclick = async () => {
          const user = auth.currentUser;
          if (user && !user.emailVerified) {
            await user.sendEmailVerification();
            alert('Verification email sent!');
          }
        };
        signOutBtn.onclick = signOutBtnMain.onclick = async () => {
          await auth.signOut();
        };
        // --- End Firebase Auth Integration ---
        // --- App Logic (AI Image Generator/Editor) ---
        const API_KEY = "AIzaSyARDUG_2e6pF0156ZovIMdkf-vINq6RiYE";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent?key=${API_KEY}`;
        // Util functions
        function displayError(msg, container) {
            container.textContent = msg;
            container.classList.remove('hidden');
        }
        function hideError(container) {
            container.textContent = '';
            container.classList.add('hidden');
        }
        function downloadImage(imgSrc, format, filenamePrefix) {
            if (!imgSrc) return;
            const filename = `${filenamePrefix}.${format.split('/')[1]}`;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                ctx.drawImage(img, 0, 0);
                const quality = format === 'image/jpeg' ? 0.8 : 1.0;
                const dataUrl = canvas.toDataURL(format, quality);
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            img.src = imgSrc;
        }
        // Navigation
        const homeSection = document.getElementById('homeSection');
        const generatorSection = document.getElementById('generatorSection');
        const editorSection = document.getElementById('editorSection');
        const menuToggleBtn = document.getElementById('menuToggleBtn');
        const navMenu = document.getElementById('navMenu');
        const showHomeBtn = document.getElementById('showHomeBtn');
        const showGeneratorBtn = document.getElementById('showGeneratorBtn');
        const showEditorBtn = document.getElementById('showEditorBtn');
        const homeToGeneratorBtn = document.getElementById('homeToGeneratorBtn');
        const homeToEditorBtn = document.getElementById('homeToEditorBtn');
        function showSection(section) {
            homeSection.classList.add('hidden');
            generatorSection.classList.add('hidden');
            editorSection.classList.add('hidden');
            showHomeBtn.classList.remove('active');
            showGeneratorBtn.classList.remove('active');
            showEditorBtn.classList.remove('active');
            if (section === 'home') {
                homeSection.classList.remove('hidden');
                showHomeBtn.classList.add('active');
            } else if (section === 'generator') {
                generatorSection.classList.remove('hidden');
                showGeneratorBtn.classList.add('active');
                hideError(document.getElementById('generatorErrorContainer'));
                document.getElementById('generatedImageResultContainer').classList.add('hidden');
            } else if (section === 'editor') {
                editorSection.classList.remove('hidden');
                showEditorBtn.classList.add('active');
                hideError(document.getElementById('editorErrorContainer'));
                document.getElementById('editorEditedImageResultContainer').classList.add('hidden');
            }
            navMenu.classList.add('hidden');
        }
        menuToggleBtn.onclick = () => navMenu.classList.toggle('hidden');
        showHomeBtn.onclick = () => showSection('home');
        showGeneratorBtn.onclick = () => showSection('generator');
        showEditorBtn.onclick = () => showSection('editor');
        homeToGeneratorBtn.onclick = () => showSection('generator');
        homeToEditorBtn.onclick = () => showSection('editor');
        document.addEventListener('DOMContentLoaded', () => showSection('home'));
        // Generator logic
        const generatorPromptInput = document.getElementById('generatorPromptInput');
        const generateImageButton = document.getElementById('generateImageButton');
        const generateButtonContent = document.getElementById('generateButtonContent');
        const generatorErrorContainer = document.getElementById('generatorErrorContainer');
        const generatedImageResultContainer = document.getElementById('generatedImageResultContainer');
        const generatedImage = document.getElementById('generatedImage');
        const downloadGeneratedButton = document.getElementById('downloadGeneratedButton');
        const generatorDownloadFormat = document.getElementById('generatorDownloadFormat');
        generateImageButton.onclick = async () => {
            generateButtonContent.innerHTML = `<svg class="animate-spin-custom h-7 w-7 mr-3 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.000 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Generating...`;
            generateImageButton.disabled = true;
            hideError(generatorErrorContainer);
            generatedImageResultContainer.classList.add('hidden');
            const prompt = generatorPromptInput.value.trim();
            if (!prompt) {
                displayError('Please enter a prompt to generate an image.', generatorErrorContainer);
                generateButtonContent.innerHTML = `<span>Generate Image</span>`;
                generateImageButton.disabled = false;
                return;
            }
            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseModalities: ["TEXT", "IMAGE"]
                    }
                };
                const response = await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || response.statusText);
                }
                const result = await response.json();
                let imageFound = false;
                if (result.candidates?.[0]?.content?.parts) {
                    for (const part of result.candidates[0].content.parts) {
                        if (part.inlineData && part.inlineData.mimeType.startsWith('image/') && part.inlineData.data) {
                            const imageUrl = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                            generatedImage.src = imageUrl;
                            generatedImageResultContainer.classList.remove('hidden');
                            imageFound = true;
                            break;
                        }
                    }
                }
                if (!imageFound) displayError('No image data received in the API response. Please try a different prompt.', generatorErrorContainer);
            } catch (err) {
                displayError(`Error generating image: ${err.message}`, generatorErrorContainer);
            } finally {
                generateButtonContent.innerHTML = `<span>Generate Image</span>`;
                generateImageButton.disabled = false;
            }
        };
        downloadGeneratedButton.onclick = () => downloadImage(generatedImage.src, generatorDownloadFormat.value, 'generated_image');
        // Editor logic
        const editorImageUpload = document.getElementById('editorImageUpload');
        const editorCustomFileUploadButton = document.getElementById('editorCustomFileUploadButton');
        const editorFileNameDisplay = document.getElementById('editorFileNameDisplay');
        const editorImagePreview = document.getElementById('editorImagePreview');
        const editorPreviewContainer = document.getElementById('editorPreviewContainer');
        const editorImagePlaceholder = document.getElementById('editorImagePlaceholder');
        const editorPromptInputText = document.getElementById('editorPromptInputText');
        const editorEditButton = document.getElementById('editorEditButton');
        const editorButtonContent = document.getElementById('editorButtonContent');
        const editorErrorContainer = document.getElementById('editorErrorContainer');
        const editorEditedImageResultContainer = document.getElementById('editorEditedImageResultContainer');
        const editorEditedImage = document.getElementById('editorEditedImage');
        const downloadEditorEditedButton = document.getElementById('downloadEditorEditedButton');
        const editorDownloadFormat = document.getElementById('editorDownloadFormat');
        let editorUploadedImageBase64 = null;
        let editorUploadedImageMimeType = null;
        editorCustomFileUploadButton.onclick = () => editorImageUpload.click();
        editorImageUpload.onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    editorUploadedImageBase64 = e.target.result;
                    editorUploadedImageMimeType = file.type;
                    editorImagePreview.src = editorUploadedImageBase64;
                    editorImagePreview.classList.remove('hidden');
                    editorImagePlaceholder.classList.add('hidden');
                    editorFileNameDisplay.textContent = file.name;
                    editorFileNameDisplay.classList.remove('text-slate-400');
                };
                reader.readAsDataURL(file);
            } else {
                editorUploadedImageBase64 = null;
                editorUploadedImageMimeType = null;
                editorImagePreview.classList.add('hidden');
                editorImagePlaceholder.classList.remove('hidden');
                editorFileNameDisplay.textContent = 'No file chosen';
                editorFileNameDisplay.classList.add('text-slate-400');
            }
        };
        editorEditButton.onclick = async () => {
            editorButtonContent.innerHTML = `<svg class="animate-spin-custom h-7 w-7 mr-3 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.000 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Editing...`;
            editorEditButton.disabled = true;
            hideError(editorErrorContainer);
            editorEditedImageResultContainer.classList.add('hidden');
            const prompt = editorPromptInputText.value.trim();
            if (!editorUploadedImageBase64) {
                displayError('Please upload an image first.', editorErrorContainer);
                editorButtonContent.innerHTML = `<span>Edit Image</span>`;
                editorEditButton.disabled = false;
                return;
            }
            if (!prompt) {
                displayError('Please enter a prompt describing how to edit the image.', editorErrorContainer);
                editorButtonContent.innerHTML = `<span>Edit Image</span>`;
                editorEditButton.disabled = false;
                return;
            }
            try {
                const chatHistory = [
                    {
                        role: "user",
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: editorUploadedImageMimeType,
                                    data: editorUploadedImageBase64.split(',')[1]
                                }
                            }
                        ]
                    }
                ];
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseModalities: ["TEXT", "IMAGE"]
                    }
                };
                const response = await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || response.statusText);
                }
                const result = await response.json();
                let imageFound = false;
                if (result.candidates?.[0]?.content?.parts) {
                    for (const part of result.candidates[0].content.parts) {
                        if (part.inlineData && part.inlineData.mimeType.startsWith('image/') && part.inlineData.data) {
                            const editedImageUrl = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                            editorEditedImage.src = editedImageUrl;
                            editorEditedImageResultContainer.classList.remove('hidden');
                            imageFound = true;
                            break;
                        }
                    }
                }
                if (!imageFound) displayError('AI did not return an image. Try refining your prompt.', editorErrorContainer);
            } catch (err) {
                displayError(`AI editing failed: ${err.message}`, editorErrorContainer);
            } finally {
                editorButtonContent.innerHTML = `<span>Edit Image</span>`;
                editorEditButton.disabled = false;
            }
        };
        downloadEditorEditedButton.onclick = () => downloadImage(editorEditedImage.src, editorDownloadFormat.value, 'ai_enhanced_image');
    </script>
</body>
</html>
